name: "Manual Wildcard Cert"

on:
  workflow_dispatch
    
jobs:
  Update-Wildcard-Cert:
    runs-on: "ubuntu-latest"
    
    steps:
      - name: "Checkout repository"
        uses: "actions/checkout@v3"

      - name: "Create Cloudflare key file"
        shell: "bash"
        env:
          CLOUDFLARE_DNS_API_TOKEN: "${{ secrets.DNS_CLOUDFLARE_API_TOKEN }}"
        run: |
          sudo mkdir /root/.secrets
          sudo touch /root/.secrets/cloudflare
          sudo chmod 600 /root/.secrets/cloudflare
          printf 'dns_cloudflare_api_token = "%s"' "$CLOUDFLARE_DNS_API_TOKEN" | sudo tee /root/.secrets/cloudflare
      
      - name: "certbot a new cert" 
        shell: "bash"
        run: |
          sudo apt update && sudo apt install python3-certbot certbot python3-certbot-nginx python3-certbot-dns-cloudflare python3-cloudflare -y
          sudo certbot certonly --dns-cloudflare --dns-cloudflare-credentials /root/.secrets/cloudflare -d "*.logfather.org" --preferred-challenges dns-01 --register-unsafely-without-email --agree-tos
          echo "${{ secrets.CERT_ENC_PWD }}" > pwd
          privkey=$(sudo readlink -f /etc/letsencrypt/live/logfather.org/privkey.pem) && openssl enc -in $privkey -aes-256-cbc -pbkdf2 -pass file:pwd > certs/privkey.pem.enc
          cert=$(sudo readlink -f /etc/letsencrypt/live/logfather.org/cert.pem) && openssl enc -in $cert -aes-256-cbc -pbkdf2 -pass file:pwd > certs/cert.pem.enc
          cachain=$(sudo readlink -f /etc/letsencrypt/live/logfather.org/fullchain.pem) && openssl enc -in $cachain -aes-256-cbc -pbkdf2 -pass file:pwd > certs/fullchain.pem.enc
      
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add .
          git commit -m "Git Actions Updated Wildcard Certificate"
          git push
