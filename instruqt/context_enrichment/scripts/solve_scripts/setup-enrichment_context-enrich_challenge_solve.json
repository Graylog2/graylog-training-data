{"id":"f6ad6396-19e3-4211-bb3b-2859721727aa","rev":3,"v":"1","name":"setup-enrichment_context-context_challenge","summary":"setup-enrichment_context-context_challenge","description":"","vendor":"Graylog Service Delivery","url":"","created_at":"2024-05-02T18:46:31.062Z","server_version":"6.0.0-rc.4+062ad58","parameters":[],"entities":[{"id":"de31aa0f-30de-4514-a4b6-55997980e02a","type":{"name":"pipeline","version":"1"},"v":"1","data":{"title":{"@type":"string","@value":"Desktop Firewalls"},"description":{"@type":"string","@value":""},"source":{"@type":"string","@value":"pipeline \"Desktop Firewalls\"\nstage 0 match either\nrule \"Parse - Firewall - GROK\"\nstage 1 match either\nrule \"Context - Desktop Firewalls - Internal Destination\"\nrule \"Context - Desktop Firewalls - Internal Source\"\nrule \"Context - Desktop Firewalls - External Destination\"\nrule \"Context - Desktop Firewalls - External Source\"\nstage 3 match either\nrule \"Context - Threat Info - Destination\"\nrule \"Context - Threat Info - Source\"\nstage 2 match either\nrule \"Enrich - Source - Asset Management\"\nrule \"Enrich - Destination - Threat Intelligence\"\nrule \"Enrich - Source - Threat Intelligence\"\nend"},"connected_streams":[{"@type":"string","@value":"4c4502a7-7189-4fc3-855b-abebd84e7173"}]},"constraints":[{"type":"server-version","version":">=6.0.0-rc.4+062ad58"}]},{"id":"ec9220b7-b461-4944-bee8-d41998e44831","type":{"name":"pipeline","version":"1"},"v":"1","data":{"title":{"@type":"string","@value":"Routing"},"description":{"@type":"string","@value":""},"source":{"@type":"string","@value":"pipeline \"Routing\"\nstage 0 match either\nrule \"Route - Desktop Firewall - MS Logs\"\nend"},"connected_streams":[{"@type":"string","@value":"99152ffd-f482-4435-9967-c1cac80b90f8"}]},"constraints":[{"type":"server-version","version":">=6.0.0-rc.4+062ad58"}]},{"id":"2c58c8b8-6366-43ab-a9a2-719178acfa96","type":{"name":"pipeline_rule","version":"1"},"v":"1","data":{"title":{"@type":"string","@value":"Context - Desktop Firewalls - External Destination"},"description":{"@type":"string","@value":""},"source":{"@type":"string","@value":"rule \"Context - Desktop Firewalls - External Destination\"\nwhen\n    has_field(\"destination_ip\") && NOT\n    (   cidr_match(\n        cidr: \"192.168.0.0/16\", \n        ip: to_ip($message.destination_ip)\n        ) OR\n        cidr_match(\n        cidr: \"10.0.0.0/8\", \n        ip: to_ip($message.destination_ip)\n        ) OR\n        cidr_match(\n        cidr: \"172.16.0.0/12\", \n        ip: to_ip($message.destination_ip)\n        ) OR\n        cidr_match(\n        cidr: \"127.0.0.0/8\", \n        ip: to_ip($message.destination_ip)\n        ) \n    )\nthen\nset_field(\"destination_is_external\",true);\nend"}},"constraints":[{"type":"server-version","version":">=6.0.0-rc.4+062ad58"}]},{"id":"8386f6d0-6fde-41d8-831e-4274374de89f","type":{"name":"pipeline_rule","version":"1"},"v":"1","data":{"title":{"@type":"string","@value":"Context - Desktop Firewalls - External Source"},"description":{"@type":"string","@value":""},"source":{"@type":"string","@value":"rule \"Context - Desktop Firewalls - External Source\"\nwhen\n    has_field(\"source_ip\") && NOT\n    (   cidr_match(\n        cidr: \"192.168.0.0/16\", \n        ip: to_ip($message.source_ip)\n        ) OR\n        cidr_match(\n        cidr: \"10.0.0.0/8\", \n        ip: to_ip($message.source_ip)\n        ) OR\n        cidr_match(\n        cidr: \"172.16.0.0/12\", \n        ip: to_ip($message.source_ip)\n        ) OR\n        cidr_match(\n        cidr: \"127.0.0.0/8\", \n        ip: to_ip($message.source_ip)\n        ) \n    )\nthen\nset_field(\"source_is_external\",true);\nend"}},"constraints":[{"type":"server-version","version":">=6.0.0-rc.4+062ad58"}]},{"id":"ca87212f-1aeb-4163-9031-1148e548fae5","type":{"name":"pipeline_rule","version":"1"},"v":"1","data":{"title":{"@type":"string","@value":"Enrich - Source - Asset Management"},"description":{"@type":"string","@value":""},"source":{"@type":"string","@value":"rule \"Enrich - Source - Asset Management\"\nwhen\n    has_field(\"source_ip\") && \n    $message.source_is_internal == true\nthen\n\nlet assetdata = lookup(\n    lookup_table: \"asset\",\n    key: to_string($message.source_ip)\n    );\nset_fields(\n    fields: assetdata,\n    prefix: \"source_\");\nset_field(\"lookup\",\"[Source - Asset Management]\");\nend\n"}},"constraints":[{"type":"server-version","version":">=6.0.0-rc.4+062ad58"}]},{"id":"aaa1f21a-09d5-48d4-84e5-06994a914ad1","type":{"name":"pipeline_rule","version":"1"},"v":"1","data":{"title":{"@type":"string","@value":"Parse - Firewall - GROK"},"description":{"@type":"string","@value":""},"source":{"@type":"string","@value":"rule \"Parse - Firewall - GROK\"\nwhen\n  ( has_field(\"route\") &&\nto_string($message.\"route\") == \"Desktop Firewall - MS Logs\"\n)\n\nthen\n  let gl2_fragment_grok_results = grok(\n  pattern: \"%{TIMESTAMP_ISO8601:event_timestamp} %{NOTSPACE:action} %{NOTSPACE:protocol} %{IP:source_ip} %{IP:destination_ip}( %{INT:source_port} %{INT:destination_port})? %{GREEDYDATA} %{WORD:path}\",\n  value: to_string($message.\"message\"),\n  only_named_captures: true\n);\nset_fields(\n  fields: gl2_fragment_grok_results\n);\n  set_field(\n    field : \"parse\",\n    value : \"Firewall - GROK\",\n    clean_field : false\n  );\nend"}},"constraints":[{"type":"server-version","version":">=6.0.0-rc.4+062ad58"}]},{"id":"24c089e8-1cc7-4485-81c8-19920f7301ea","type":{"name":"pipeline_rule","version":"1"},"v":"1","data":{"title":{"@type":"string","@value":"Context - Desktop Firewalls - Internal Destination"},"description":{"@type":"string","@value":""},"source":{"@type":"string","@value":"rule \"Context - Desktop Firewalls - Internal Destination\"\nwhen\n    has_field(\"destination_ip\") &&\n    (   cidr_match(\n        cidr: \"192.168.0.0/16\", \n        ip: to_ip($message.destination_ip)\n        ) OR\n        cidr_match(\n        cidr: \"10.0.0.0/8\", \n        ip: to_ip($message.destination_ip)\n        ) OR\n        cidr_match(\n        cidr: \"172.16.0.0/12\", \n        ip: to_ip($message.destination_ip)\n        ) OR\n        cidr_match(\n        cidr: \"127.0.0.0/8\", \n        ip: to_ip($message.destination_ip)\n        ) \n    )\nthen\nset_field(\"destination_is_internal\",true);\nend\n"}},"constraints":[{"type":"server-version","version":">=6.0.0-rc.4+062ad58"}]},{"id":"a684d576-d020-4b91-9d00-709229e16f9a","type":{"name":"pipeline_rule","version":"1"},"v":"1","data":{"title":{"@type":"string","@value":"Context - Threat Info - Destination"},"description":{"@type":"string","@value":""},"source":{"@type":"string","@value":"rule \"Context - Threat Info - Destination\"\nwhen\n    $message.threat_classification == \"malicious\" &&\n    $message.destination_is_external == true\nthen\n    set_field(\"threat_detected\",true);\n    set_field(\"threat_info_url\",concat(\n        first: \"https://www.greynoise.io/viz/ip/\",\n        second: to_string($message.destination_ip)\n            )\n        );\nend\n"}},"constraints":[{"type":"server-version","version":">=6.0.0-rc.4+062ad58"}]},{"id":"d52346e9-f69a-4eea-b899-a034aa489870","type":{"name":"pipeline_rule","version":"1"},"v":"1","data":{"title":{"@type":"string","@value":"Context - Desktop Firewalls - Internal Source"},"description":{"@type":"string","@value":""},"source":{"@type":"string","@value":"rule \"Context - Desktop Firewalls - Internal Source\"\nwhen\n    has_field(\"source_ip\") &&\n    (   cidr_match(\n        cidr: \"192.168.0.0/16\", \n        ip: to_ip($message.source_ip)\n        ) OR\n        cidr_match(\n        cidr: \"10.0.0.0/8\", \n        ip: to_ip($message.source_ip)\n        ) OR\n        cidr_match(\n        cidr: \"172.16.0.0/12\", \n        ip: to_ip($message.source_ip)\n        ) OR\n        cidr_match(\n        cidr: \"127.0.0.0/8\", \n        ip: to_ip($message.source_ip)\n        ) \n    )\nthen\nset_field(\"source_is_internal\",true);\nend\n"}},"constraints":[{"type":"server-version","version":">=6.0.0-rc.4+062ad58"}]},{"id":"857cf6a3-a1cd-47bb-88ef-fe88f1b76eb6","type":{"name":"pipeline_rule","version":"1"},"v":"1","data":{"title":{"@type":"string","@value":"Enrich - Destination - Threat Intelligence"},"description":{"@type":"string","@value":""},"source":{"@type":"string","@value":"rule \"Enrich - Destination - Threat Intelligence\"\nwhen\n    has_field(\"destination_ip\") && \n    $message.destination_is_external == true\nthen\n\n//Grab Geo Details\nlet geo = lookup(\n    lookup_table: \"geo-ip\",\n    key: to_string($message.destination_ip)\n);\n\n//Set fields with enriched details\nset_field(\"destination_geo_city_name\",geo[\"city\"].names.en);\nset_field(\"destination_geo_country_name\",geo[\"country\"].names.en);\nset_field(\"destination_geo_coordinates\",geo[\"coordinates\"]);\nset_field(\"Enriched\",\"destination - Threat Intelligence\");\n\n//Check for threat on IP\nlet intel = lookup(\n    lookup_table: \"greynoise-lookup\",\n    key: to_string($message.destination_ip)\n);\n\n//Set classification Detail from Graynoise\nset_field(\"threat_classification\",intel[\"classification\"]);\n\nend"}},"constraints":[{"type":"server-version","version":">=6.0.0-rc.4+062ad58"}]},{"id":"b658ff2f-0ea1-4a1d-b5b0-2f52015ed6c1","type":{"name":"pipeline_rule","version":"1"},"v":"1","data":{"title":{"@type":"string","@value":"Enrich - Source - Threat Intelligence"},"description":{"@type":"string","@value":""},"source":{"@type":"string","@value":"rule \"Enrich - Source - Threat Intelligence\"\nwhen\n    has_field(\"source_ip\") && \n    $message.source_is_external == true\nthen\n\n//Grab Geo Details\nlet geo = lookup(\n    lookup_table: \"geo-ip\",\n    key: to_string($message.source_ip)\n);\n\n//Set fields with enriched details\nset_field(\"source_geo_city_name\",geo[\"city\"].names.en);\nset_field(\"source_geo_country_name\",geo[\"country\"].names.en);\nset_field(\"source_geo_coordinates\",geo[\"coordinates\"]);\nset_field(\"Enriched\",\"Source - Threat Intelligence\");\n\n//Check for threat on IP\nlet intel = lookup(\n    lookup_table: \"greynoise-lookup\",\n    key: to_string($message.source_ip)\n);\n\n//Set classification Detail from Graynoise\nset_field(\"threat_classification\",intel[\"classification\"]);\n\nend\n"}},"constraints":[{"type":"server-version","version":">=6.0.0-rc.4+062ad58"}]},{"id":"94d401eb-03f7-40b8-aea4-2ed8b339edab","type":{"name":"pipeline_rule","version":"1"},"v":"1","data":{"title":{"@type":"string","@value":"Context - Threat Info - Source"},"description":{"@type":"string","@value":""},"source":{"@type":"string","@value":"rule \"Context - Threat Info - Source\"\nwhen\n    $message.threat_classification == \"malicious\" && \n    $message.source_is_external == true\nthen\n    set_field(\"threat_detected\",true);\n    set_field(\"threat_info_url\",concat(\n        first: \"https://www.greynoise.io/viz/ip/\",\n        second: to_string($message.source_ip)\n            )\n        );\nend\n"}},"constraints":[{"type":"server-version","version":">=6.0.0-rc.4+062ad58"}]},{"id":"ff70a695-106e-4c26-9dfb-cf42a8b074e8","type":{"name":"pipeline_rule","version":"1"},"v":"1","data":{"title":{"@type":"string","@value":"Route - Desktop Firewall - MS Logs"},"description":{"@type":"string","@value":""},"source":{"@type":"string","@value":"rule \"Route - Desktop Firewall - MS Logs\"\nwhen\n  grok(\n  value: to_string($message.\"message\"),\n  pattern: \"%{TIMESTAMP_ISO8601:event_timestamp} %{NOTSPACE:action} %{NOTSPACE:protocol} %{IP:sre_ip} %{IP:dst_ip}( %{INT:src_port} %{INT:dst_port})? %{GREEDYDATA} %{WORD:path}\"\n).matches == true\nthen\n  route_to_stream(\n    name : \"Desktop Firewall Events\",\n    remove_from_default : true\n  );\n  set_field(\n    field : \"route\",\n    value : \"Desktop Firewall - MS Logs\"\n  );\nend"}},"constraints":[{"type":"server-version","version":">=6.0.0-rc.4+062ad58"}]},{"id":"4c4502a7-7189-4fc3-855b-abebd84e7173","type":{"name":"stream_title","version":"1"},"v":"1","data":{"title":{"@type":"string","@value":"Desktop Firewall Events"}},"constraints":[{"type":"server-version","version":">=6.0.0-rc.4+062ad58"}]},{"id":"99152ffd-f482-4435-9967-c1cac80b90f8","type":{"name":"stream_title","version":"1"},"v":"1","data":{"title":{"@type":"string","@value":"Default Stream"}},"constraints":[{"type":"server-version","version":">=6.0.0-rc.4+062ad58"}]}]}