##### /etc/nginx/nginx.conf #####
user www-data;
worker_processes auto;
pid /run/nginx.pid;
include /etc/nginx/modules-enabled/*.conf;
events { worker_connections 1024; }

http {
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        types_hash_max_size 2048;
        include /etc/nginx/mime.types;
        default_type application/octet-stream;
        ssl_protocols TLSv1.2;
        ssl_prefer_server_ciphers on;
        gzip on;
        include /etc/nginx/conf.d/*.conf;
        #include /etc/nginx/sites-enabled/*;

        server_tokens off;

        log_format graylog_json escape=json '{ "nginx_timestamp": "$time_iso8601", '
                '"remote_addr": "$remote_addr", '
                '"connection": "$connection", '
                '"connection_requests": $connection_requests, '
                '"pipe": "$pipe", '
                '"body_bytes_sent": $body_bytes_sent, '
                '"request_length": $request_length, '
                '"request_time": $request_time, '
                '"response_status": $status, '
                '"request": "$request", '
                '"request_method": "$request_method", '
                '"host": "$host", '
                '"upstream_cache_status": "$upstream_cache_status", '
                '"upstream_addr": "$upstream_addr", '
                '"http_x_forwarded_for": "$http_x_forwarded_for", '
                '"http_referrer": "$http_referer", '
                '"http_user_agent": "$http_user_agent", '
                '"http_version": "$server_protocol", '
                '"remote_user": "$remote_user", '
                '"http_x_forwarded_proto": "$http_x_forwarded_proto", '
                '"upstream_response_time": "$upstream_response_time", '
                '"nginx_access": true }';

        access_log /var/log/nginx/access.log;
        error_log  /var/log/nginx/error.log;

        upstream graylog {
                server 192.168.1.231:9000 max_fails=3 fail_timeout=30s;
                server 192.168.99.254:9000 max_fails=3 fail_timeout=30s;
                server 192.168.99.253:9000 max_fails=3 fail_timeout=30s;
        }

        upstream graylog_master {
                server 192.168.1.231:9000 max_fails=3 fail_timeout=30s;
        }

        upstream overwatch {
                server 192.168.2.248:80 max_fails=3 fail_timeout=30s;
        }

        upstream proxmox {
                server 192.168.1.254:8006 max_fails=3 fail_timeout=30s;
                server 192.168.1.251:8006 max_fails=3 fail_timeout=30s;
                server 192.168.1.249:8006 max_fails=3 fail_timeout=30s;
        }
        upstream proxmox_spice {
                server 192.168.1.254:3128 max_fails=3 fail_timeout=30s;
                server 192.168.1.251:3128 max_fails=3 fail_timeout=30s;
                server 192.168.1.249:3128 max_fails=3 fail_timeout=30s;
        }
        upstream proxmox_vnc {
                server 192.168.1.254 max_fails=3 fail_timeout=30s;
                server 192.168.1.251 max_fails=3 fail_timeout=30s;
                server 192.168.1.249 max_fails=3 fail_timeout=30s;
        }
        upstream proxmox_ceph {
                server 192.168.1.254:8443 max_fails=3 fail_timeout=30s;
                server 192.168.1.251:8443 max_fails=3 fail_timeout=30s;
                server 192.168.1.249:8443 max_fails=3 fail_timeout=30s;
        }
        upstream proxmox_backup {
                server 192.168.1.230:8007 max_fails=3 fail_timeout=30s;
        }

        upstream sensors {
                server 192.168.1.250:80 max_fails=3 fail_timeout=30s;
        }

        upstream cloud {
                server 192.168.5.253 max_fails=3 fail_timeout=30s;
        }

        upstream 3cx  {
                server 192.168.5.254:5001 max_fails=3 fail_timeout=30s;
        }

        upstream ombi {
                server 192.168.5.249:5000 max_fails=3 fail_timeout=30s;
        }

        upstream tplink {
                server 192.168.1.3:8043 max_fails=3 fail_timeout=30s;
        }
        upstream unifi {
                server 192.168.1.2:8443 max_fails=3 fail_timeout=30s;
        }

########################################## DEFAULTS ################################################
    server {
        listen 80;
        server_name "";
        return 403;
        deny all;
        access_log /var/log/nginx/http_default.access.log graylog_json;
        error_log  /var/log/nginx/http_default.error.log;
    }
    server {
                listen 443 ssl;
                deny all;
                ssl_certificate /etc/nginx/certs/<CERT FILE>;
                ssl_certificate_key /etc/nginx/certs/<CERT KEY>;
                ssl_session_cache   shared:SSL:10m;
                ssl_protocols  TLSv1.2;
                access_log /var/log/nginx/https_default.access.log graylog_json;
                error_log  /var/log/nginx/https_default.org.error.log;
                location / {
                        proxy_set_header        Host $host;
                        proxy_set_header        X-Real-IP $remote_addr;
                        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header        X-Forwarded-Proto $scheme;
                }
        }

##################################### Graylog #####################################################
        server {
                listen 80;
                server_name graylog.eclipsenetwork.org;
                return 301 https://$host$request_uri;
                access_log /var/log/nginx/http_graylog.eclipsenetwork.org.access.log graylog_json;
                error_log  /var/log/nginx/http_graylog.eclipsenetwork.org.error.log;
        }

        server {
                listen 443 ssl;
                server_name  graylog.eclipsenetwork.org;
                ssl_certificate /etc/nginx/certs/<CERT FILE>;
                ssl_certificate_key /etc/nginx/certs/<CERT KEY>;
                ssl_session_cache   shared:SSL:10m;
                ssl_session_timeout 5m;
                ssl_protocols       TLSv1.2;
                index index.html index.htm index.php;
                access_log /var/log/nginx/https_graylog.access.log graylog_json;
                error_log  /var/log/nginx/https_graylog.error.log;
                location / {
                        if ($request_method ~* "(GET|POST)") {
                                add_header "Access-Control-Allow-Origin" *;
                        }
                        if ($request_method = OPTIONS ) {
                                add_header "Access-Control-Allow-Origin" *;
                                add_header "Access-Control-Allow-Methods" "GET,POST, OPTIONS, HEAD";
                                add_header "Access-Control-Allow-Headers" "Authorization, Origin, X-Requested-With, Content-Type, Accept";
                                return 200;
                        }
                        proxy_pass http://graylog;
                        proxy_redirect https://graylog:443/api /api;
                        proxy_read_timeout 90;
                        proxy_connect_timeout 90;
                        proxy_set_header Host $http_host;
                        proxy_set_header X-Forwarded-Host   $host;
                        proxy_set_header X-Forwarded-Server $host;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header X-Graylog-Server-URL https://$server_name/;
                }
                location /api/plugins/org.graylog.plugins.archive/ {
                        if ($request_method ~* "(GET|POST)") {
                                add_header "Access-Control-Allow-Origin" *;
                        }
                        if ($request_method = OPTIONS ) {
                                add_header "Access-Control-Allow-Origin" *;
                        add_header "Access-Control-Allow-Methods" "GET, POST, OPTIONS, HEAD";
                                add_header "Access-Control-Allow-Headers" "Authorization, Origin, X-Requested-With, Content-Type, Accept";
                                return 200;
                        }
                        proxy_pass http://graylog_master/api/plugins/org.graylog.plugins.archive/;
                        proxy_redirect https://graylog:443/api/plugins/org.graylog.plugins.archive/ /api/plugins/org.graylog.plugins.archive/;
                        proxy_read_timeout 90;
                        proxy_connect_timeout 90;
                        proxy_set_header Host $http_host;
                        proxy_set_header X-Forwarded-Host   $host;
                        proxy_set_header X-Forwarded-Server $host;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header X-Graylog-Server-URL
                        https://$server_name/;
                }
        }
}
#################################################
#                                               #
#   *****  *     *  ***   *   *  *****   ***    #
#     *    **    *  *  *  *   *    *    *   *   #
#     *    * *   *  *  *  *   *    *    *       #
#     *    *  *  *  ***   *   *    *     ***    #
#     *    *   * *  *     *   *    *        *   #
#     *    *    **  *     *   *    *    *   *   #
#   *****  *     *  *      ***     *     ***    #
#                                               #
#################################################
stream {

        upstream graylog_input_3cx-plain-linux {
                server 192.168.1.231:3000 max_fails=3 fail_timeout=30s;
                server 192.168.99.254:3000 max_fails=3 fail_timeout=30s;
                server 192.168.99.253:3000 max_fails=3 fail_timeout=30s;
        }
        upstream graylog_input_beats-plain {
                server 192.168.1.231:5044 max_fails=3 fail_timeout=30s;
                server 192.168.99.254:5044 max_fails=3 fail_timeout=30s;
                server 192.168.99.253:5044 max_fails=3 fail_timeout=30s;
        }
        upstream graylog_input_beats-plain-windows {
                server 192.168.1.231:5045 max_fails=3 fail_timeout=30s;
                server 192.168.99.254:5045 max_fails=3 fail_timeout=30s;
                server 192.168.99.253:5045 max_fails=3 fail_timeout=30s;
        }
        upstream graylog_input_beats-plain-linux {
                server 192.168.1.231:5046 max_fails=3 fail_timeout=30s;
                server 192.168.99.254:5046 max_fails=3 fail_timeout=30s;
                server 192.168.99.253:5046 max_fails=3 fail_timeout=30s;
        }
        upstream unifi_syslog-linux {
                server 192.168.1.231:1515 max_fails=3 fail_timeout=30s;
                server 192.168.99.254:1515 max_fails=3 fail_timeout=30s;
                server 192.168.99.253:1515 max_fails=3 fail_timeout=30s;
        }
        upstream customer-data {
                server 192.168.1.231:12202 max_fails=3 fail_timeout=30s;
                server 192.168.99.254:12202 max_fails=3 fail_timeout=30s;
                server 192.168.99.253:12202 max_fails=3 fail_timeout=30s;
        }
        upstream pfsense {
                server 192.168.1.231:1514 max_fails=3 fail_timeout=30s;
                server 192.168.99.254:1514 max_fails=3 fail_timeout=30s;
                server 192.168.99.253:1514 max_fails=3 fail_timeout=30s;
        }
        upstream coreswitch {
                server 192.168.1.231:1470 max_fails=3 fail_timeout=30s;
                server 192.168.99.254:1470 max_fails=3 fail_timeout=30s;
                server 192.168.99.253:1470 max_fails=3 fail_timeout=30s;
        }
        upstream graylog_input_windows_filebeat {
                server 192.168.1.231:5055 max_fails=3 fail_timeout=30s;
                server 192.168.99.254:5055 max_fails=3 fail_timeout=30s;
                server 192.168.99.253:5055 max_fails=3 fail_timeout=30s;
        }
        server {
                listen 1470 udp;
                proxy_pass pfsense;
                proxy_timeout 1s;
                error_log /var/log/nginx/unifi_input_coreswitch_error.log;
        }
        server {
                listen 1514 udp;
                proxy_pass pfsense;
                proxy_timeout 1s;
                error_log /var/log/nginx/unifi_input_pfsense_error.log;
        }
        server {
                listen 1515 udp;
                proxy_pass unifi_syslog-linux;
                proxy_timeout 1s;
                error_log /var/log/nginx/unifi_input_syslog_error.log;
        }
        server {
                listen 3000;
                proxy_pass graylog_input_3cx-plain-linux;
                proxy_timeout 1s;
                error_log /var/log/nginx/graylog_input_beats-plain_error.log;
        }
        server {
                listen 5044;
                proxy_pass graylog_input_beats-plain;
                proxy_timeout 1s;
                error_log /var/log/nginx/graylog_input_beats-plain_error.log;
        }
        server {
                listen 5045;
                proxy_pass graylog_input_beats-plain-windows;
                proxy_timeout 1s;
                error_log /var/log/nginx/graylog_input_beats-plain-windows_error.log;
        }
        server {
                listen 5046;
                proxy_pass graylog_input_beats-plain-linux;
                proxy_timeout 1s;
                error_log /var/log/nginx/graylog_input_beats-plain-linux_error.log;
        }
        server {
                listen 5055;
                proxy_pass graylog_input_windows_filebeat;
                proxy_timeout 1s;
                error_log /var/log/nginx/graylog_input_windows_filebeat_error.log;
        }
        server {
                listen 12202;
                proxy_pass customer-data;
                proxy_timeout 1s;
                error_log /var/log/nginx/graylog_input_customer-data.log;
        }
}
####################################################################################################
