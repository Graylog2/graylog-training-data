##### /etc/nginx/nginx.conf #####
user www-data;
worker_processes auto;
pid /run/nginx.pid;
include /etc/nginx/modules-enabled/*.conf;
events { worker_connections 1024; }

http {

        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        types_hash_max_size 2048;
        include /etc/nginx/mime.types;
        default_type application/octet-stream;
        ssl_protocols TLSv1.2;
        ssl_prefer_server_ciphers on;
        gzip on;
        include /etc/nginx/conf.d/*.conf;
        #include /etc/nginx/sites-enabled/*;

        server_tokens off;

        access_log /var/log/nginx/access.log;
        error_log  /var/log/nginx/error.log;
        
################ Update this to include the real Graylog Servers ####################################
        upstream graylog {
                server 172.16.1.1:9000 max_fails=3 fail_timeout=30s;
                server 172.16.1.2:9000 max_fails=3 fail_timeout=30s;
                server 172.16.1.3:9000 max_fails=3 fail_timeout=30s;
        }

        upstream graylog_primary {
                server 172.16.1.1:9000 max_fails=3 fail_timeout=30s;
        }

########################################## DEFAULTS ################################################
    server {
        listen 80;
        set $LABDNS "name-lab.logfather.org";
        server_name $LABDNS;

        return 403;
        deny all;
        access_log /var/log/nginx/http_default.access.log;
        error_log  /var/log/nginx/http_default.error.log;
    }
    server {
                listen 443 ssl;
                deny all;
                ssl_certificate /home/admin/class/certs/cert.pem;
                ssl_certificate_key /home/admin/class/certs/privkey.pem;
                ssl_session_cache   shared:SSL:10m;
                ssl_protocols  TLSv1.2;
                access_log /var/log/nginx/https_default.access.log;
                error_log  /var/log/nginx/https_default.org.error.log;
                location / {
                        proxy_set_header        X-Real-IP $remote_addr;
                        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header        X-Forwarded-Proto $scheme;
                }
        }
        

##################################### Graylog #####################################################
        server {
                
                set $LABDNS "name-lab.logfather.org";
        
                listen 80;
                server_name $LABDNS;
                return 301 https://$request_uri;
                access_log /var/log/nginx/http_graylog.access.log;
                error_log  /var/log/nginx/http_graylog.error.log;
        }

        server {
                set $LABDNS "name-lab.logfather.org";
        
                listen 443 ssl;
                server_name $LABDNS;
                ssl_certificate /home/admin/class/certs/cert.pem;
                ssl_certificate_key /home/admin/class/certs/privkey.pem;
                ssl_session_cache   shared:SSL:10m;
                ssl_session_timeout 5m;
                ssl_protocols       TLSv1.2;
                index index.html index.htm index.php;
                access_log /var/log/nginx/https_graylog.access.log;
                error_log  /var/log/nginx/https_graylog.error.log;
                location / {
                        if ($request_method ~* "(GET|POST)") {
                                add_header "Access-Control-Allow-Origin" *;
                        }
                        if ($request_method = OPTIONS ) {
                                add_header "Access-Control-Allow-Origin" *;
                                add_header "Access-Control-Allow-Methods" "GET,POST, OPTIONS, HEAD";
                                add_header "Access-Control-Allow-Headers" "Authorization, Origin, X-Requested-With, Content-Type, Accept";
                                return 200;
                        }
                        proxy_pass http://graylog;
                        proxy_redirect https://graylog:443/api /api;
                        proxy_read_timeout 90;
                        proxy_connect_timeout 90;
                        proxy_set_header X-Forwarded-   $;
                        proxy_set_header X-Forwarded-Server $;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header X-Graylog-Server-URL https://$LABDNS/;
                }
                location /api/plugins/org.graylog.plugins.archive/ {
                        if ($request_method ~* "(GET|POST)") {
                                add_header "Access-Control-Allow-Origin" *;
                        }
                        if ($request_method = OPTIONS ) {
                                add_header "Access-Control-Allow-Origin" *;
                        add_header "Access-Control-Allow-Methods" "GET, POST, OPTIONS, HEAD";
                                add_header "Access-Control-Allow-Headers" "Authorization, Origin, X-Requested-With, Content-Type, Accept";
                                return 200;
                        }
                        proxy_pass http://graylog_primary/api/plugins/org.graylog.plugins.archive/;
                        proxy_redirect https://graylog:443/api/plugins/org.graylog.plugins.archive/ /api/plugins/org.graylog.plugins.archive/;
                        proxy_read_timeout 90;
                        proxy_connect_timeout 90;
                        proxy_set_header X-Forwarded-   $;
                        proxy_set_header X-Forwarded-Server $;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header X-Graylog-Server-URL
                        https://$server_name/;
                }
        }
}
#################################################
#                                               #
#   *****  *     *  ***   *   *  *****   ***    #
#     *    **    *  *  *  *   *    *    *   *   #
#     *    * *   *  *  *  *   *    *    *       #
#     *    *  *  *  ***   *   *    *     ***    #
#     *    *   * *  *     *   *    *        *   #
#     *    *    **  *     *   *    *    *   *   #
#   *****  *     *  *      ***     *     ***    #
#                                               #
#################################################
stream {

    set node_0 example1.strigo.io;
    set node_1 example2.strigo.io;
    set node_2 example3.strigo.io;
    
        upstream syslog {
                server $node_0:514 max_fails=3 fail_timeout=30s;
                server $node_1:514 max_fails=3 fail_timeout=30s;
                server $node_2:514 max_fails=3 fail_timeout=30s;
        }
        upstream graylog_input_beats-plain {
                server $node_0:5044 max_fails=3 fail_timeout=30s;
                server $node_1:5044 max_fails=3 fail_timeout=30s;
                server $node_2:5044 max_fails=3 fail_timeout=30s;
        }
        upstream graylog_input_beats-plain-windows {
                server $node_0:5045 max_fails=3 fail_timeout=30s;
                server $node_1:5045 max_fails=3 fail_timeout=30s;
                server $node_2:5045 max_fails=3 fail_timeout=30s;
        }
        upstream graylog_input_beats-plain-linux {
                server $node_0:5046 max_fails=3 fail_timeout=30s;
                server $node_1:5046 max_fails=3 fail_timeout=30s;
                server $node_2:5046 max_fails=3 fail_timeout=30s;
        }
        upstream graylog_input_windows_filebeat {
                server $node_0:5055 max_fails=3 fail_timeout=30s;
                server $node_1:5055 max_fails=3 fail_timeout=30s;
                server $node_2:5055 max_fails=3 fail_timeout=30s;
        }
        server {
                listen 514 udp;
                proxy_pass syslog;
                proxy_timeout 1s;
                error_log /var/log/nginx/unifi_input_syslog_error.log;
        }
        server {
                listen 5044;
                proxy_pass graylog_input_beats-plain;
                proxy_timeout 1s;
                error_log /var/log/nginx/graylog_input_beats-plain_error.log;
        }
        server {
                listen 5045;
                proxy_pass graylog_input_beats-plain-windows;
                proxy_timeout 1s;
                error_log /var/log/nginx/graylog_input_beats-plain-windows_error.log;
        }
        server {
                listen 5046;
                proxy_pass graylog_input_beats-plain-linux;
                proxy_timeout 1s;
                error_log /var/log/nginx/graylog_input_beats-plain-linux_error.log;
        }
        server {
                listen 5055;
                proxy_pass graylog_input_windows_filebeat;
                proxy_timeout 1s;
                error_log /var/log/nginx/graylog_input_windows_filebeat_error.log;
        }

}
####################################################################################################
